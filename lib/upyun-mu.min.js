(function(){"use strict";function a(a,b){for(var c in b)a[c]=b[c]}function b(a){var b=[],c={};for(var d in a)a.hasOwnProperty(d)&&b.push(d);b.sort();for(var e=0;e<b.length;e++){var f=b[e];c[f]=a[f]}return c}function c(a,c){if("object"==typeof a){var d=b(a),e="";for(var f in d)"signature"!==f&&(e=e+f+d[f]);var g=SparkMD5.hash(e+c);return g}}function d(a){var b=[];for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")}function e(a){for(var b=[],c=a.indexOf(0);-1!=c;)b.push(c),c=a.indexOf(0,c+1);return b}function f(b){var f=this;async.waterfall([function(a){function b(){var a=new FileReader;a.onload=l,a.onerror=m;var b=j*g,c=b+g>=f.size?f.size:b+g,d=e.call(f,b,c);a.readAsArrayBuffer(d)}var c={chunksHash:{}},d=document.getElementById("file").files;if(!d.length)return void console.log("no file is selected");var e=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,f=d[0],g=h.chunkSize,i=Math.ceil(f.size/g),j=0,k=new SparkMD5.ArrayBuffer,l=function(d){return c.chunksHash[j]=SparkMD5.ArrayBuffer.hash(d.target.result),k.append(d.target.result),j++,i>j?void b():(c.entire=k.end(),c.chunksNum=i,c.file_size=f.size,void a(null,c))},m=function(){console.warn("oops, something went wrong.")};b()},function(e,g){var i={path:b,expiration:h.expiration,file_blocks:e.chunksNum,file_size:e.file_size,file_hash:e.entire};a(i,f.options);var j=null;j=f._signature?f._signature:c(i,h.form_api_secret);var k=btoa(JSON.stringify(i)),l={policy:k,signature:j},m=d(l),n=new XMLHttpRequest;n.open("POST",h.api+h.bucket+"/"),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onload=function(a){if(200==n.status){if(JSON.parse(n.response).status.indexOf(0)<0)return g(new Error("file already exists"));g(null,e,n.response)}else n.send(m)},n.send(m)},function(a,b,d){b=JSON.parse(b);var f,g=h.chunkSize,i=document.getElementById("file").files[0],j=b.status;async.until(function(){return e(j).length<=0},function(d){var k=e(j)[0],l=k*g,m=l+g>=i.size?i.size:l+g,n=i.slice(l,m),o={save_token:b.save_token,expiration:h.expiration,block_index:k,block_hash:a.chunksHash[k]},p=c(o,b.token_secret),q=btoa(JSON.stringify(o)),r=new FormData;r.append("policy",q),r.append("signature",p),r.append("file",n);var s=new XMLHttpRequest;s.onreadystatechange=function(a){4===a.currentTarget.readyState&&200==a.currentTarget.status&&(j=JSON.parse(a.currentTarget.response).status,f=s.response,d(null))},s.open("POST",h.api+h.bucket+"/",!1),s.send(r)},function(b){b&&d(b),d(null,a,f)})},function(a,b,e){b=JSON.parse(b);var f={save_token:b.save_token,expiration:h.expiration},g=c(f,b.token_secret),i=btoa(JSON.stringify(f)),j={policy:i,signature:g},k=d(j),l=new XMLHttpRequest;l.open("POST",h.api+h.bucket+"/"),l.setRequestHeader("Content-type","application/x-www-form-urlencoded"),l.onload=function(a){200==l.status?e(null,l.response):e(null,l.response)},l.send(k)}],function(a,b){var c=null;return a?"function"==typeof CustomEvent?(c=new CustomEvent("error",{detail:a}),void document.dispatchEvent(c)):(c=document.createEvent("CustomEvent"),c.initCustomEvent("error",!1,!1,a),void document.dispatchEvent(c)):void("function"==typeof CustomEvent?(c=new CustomEvent("uploaded",{detail:JSON.parse(b)}),document.dispatchEvent(c)):(c=document.createEvent("CustomEvent"),c.initCustomEvent("uploaded",!1,!1,JSON.parse(b)),document.dispatchEvent(c)))})}function g(b){a(h,b),b.signature&&(this._signature=b.signature),this.setOptions=function(a){this.options=a},this.upload=f}var h={api:"http://m0.api.upyun.com/",chunkSize:1048576};this.Sand=g}).call(this);